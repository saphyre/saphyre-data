# Saphyre - Data

This module is used to handle big databases without the need to create complex queries. The queries are dynamically generated by this module just by chosing the modifiers to get the result.

## Query Modifiers

There are some options you can use to change query.
They are all named and can be used in a request. Also, there's no need to join tables, all associations are handled by Sequelize within each *option*.

### Projection

Projections are used to indicate the fields to select from the database, this option is similar to SQL SELECT, but you can name every projection with all fields required.

It's also possible to create custom middlewares to customize the data.

### Criteria

Criterias are used to indicate the filter option from the database, this option is similar to SQL WHERE, but you can name every criteria with all fields required and it's required inputs.

### Sort

Sorts are used to indicate the order option from the database, this option is similar to SQL ORDER BY bu you can name every sort with all fields required.

### Relationship

Relationships are used if you want to list associated models to each other. You have to configure the association you have.

For example: We have `Article`, `Tag` and `Newsletter`.
**Article** has some **Tags** and **Newsletter** has some **Tags**.

So if we create a relationship on **Article** with **Tag** and **Newsletter** with **Tags**, We can determine **Newsletters** associated with **Article** by **Tags** or vice versa.

## API

### Projection

    var SaphyreData = require('saphyre-data'),
        data = new SaphyreData(),
        model = data.createModel('article', Article);
    // Article is a Sequelize Model
        
    // creating a projection to be used on list
    model.projection('list', {
        'article_id' : 'id', // article_id as id
        'created_at' : 'created_at',
        'title' : 'title',
        
        // the association Author will be automatically joined
        'Author.user_id' : 'author.id', 
        // an object author will be created
        'Author.nickname' : 'author.nickname', 
        // nickname will be a property of the author object recently created
        'Author.slug' : 'author.slug',
        
        // Association Category will be automatically joined
        'Category.name' : 'category' 
    }).use(function (article) {
        article.author.thumbnail = '/users/thumbnail/' + article.author.id;
    }).use(function (article) {
        console.log(article);
    });
    
Its possible to use functions on a projection

    'Tags.tag_id' : {
        alias : 'tags_count',
        func : SaphyreData.functions.count
    }
    
For HasMany and HasOne the QueryBuilder will LEFT JOIN the table, if you want to INNER JOIN the table:

    'Tags.tag_id' : {
        alias : 'tags_count',
        func : SaphyreData.functions.count,
        joinType : 'inner' // case sensitive
    }
    
#### Console output for each row
    {
        "id" : 1,
        "created_at" : Tue Feb 17 2015 12:50:47 GMT-0300 (BRT),
        "title" : "Article title",
        "author" : {
            "id" : 1,
            "nickname" : "Author",
            "slug" : "author-slug",
            "thumbnail" : "/users/thumbnail/1"
        },
        "category" : "Category Name"
    }
    
### Criteria

    model.criteria('author', {
        name : 'id', // this is the name of the parameter
        property : 'author_id', // the property to check
        operator : SaphyreData.OPERATOR.EQUAL // the operator
    });
    
It's also possible to use an array of parameters
    
    model.criteria('custom', [
        {/* param 1 */}, 
        {/* param 2 */}
    ]);
    
There's an option to pass a static value to criteria parameters:

    model.criteria('non-removed', {
        name : 'status',
        property : 'status',
        operator : SaphyreData.OPERATOR.EQUAL,
        value : ArticleStatus.REMOVED
    });
    
It's also possible to use dynamic values, passing a function will evoke everytime a query is constructed.

    model.criteria('today', {
        name : 'date',
        property : 'publish_dt',
        operator : SaphyreData.OPERATOR.GREATER_EQUAL,
        value : function () {
            return new Date();
        }
    });
    
**Note:** Currently there's no option to use OR operator to join expressions

### Sort

    model.sort('recent', { 'publish_dt' : 'DESC' });
    
It's possible to sort on a RAW text, like alias.

    model.sort('recent', {
        'publish_dt' : {
            raw : true,
            direction : 'DESC'
        }
    });
    
    
## Data retrieval

    model.requestList({
        projection : 'list',
        criteria : {
            'non-removed' : true, // in this case, there's no value to pass
            'author' : 1 // it's possible to use 0..N criterias
        },
        page : 1,
        pageSize : 20,
        sort : 'recent'
    }).then(function (result) {
        // result.list -> the list
        // result.count -> the total elements
    });
    
    model.single({
        projection : 'list',
        criteria : {
            'non-removed' : true, // in this case, there's no value to pass
            'author' : 1 // it's possible to use 0..N criterias
        },
        sort : 'recent'
    }).then(function (theFirstItem) {
        
    });
    
## Operators

    SaphyreData.OPERATOR.NOT_EQUAL
    SaphyreData.OPERATOR.EQUAL
    SaphyreData.OPERATOR.LESS_EQUAL
    SaphyreData.OPERATOR.GREATER_EQUAL
    SaphyreData.OPERATOR.LESS_THAN
    SaphyreData.OPERATOR.GREATER_THAN
    SaphyreData.OPERATOR.LIKE
    SaphyreData.OPERATOR.ILIKE
    SaphyreData.OPERATOR.BETWEEN
    SaphyreData.OPERATOR.HAS
    
When using **BETWEEN**, the value passed must be an array with length >= 2